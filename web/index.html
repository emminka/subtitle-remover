<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Subtitle remover</title>
    <meta http-equiv="Content-Security-Policy" content="default-src * self blob: data: gap:; style-src * self 'unsafe-inline' blob: data: gap:; script-src * 'self' 'unsafe-eval' 'unsafe-inline' blob: data: gap:; object-src * 'self' blob: data: gap:; img-src * self 'unsafe-inline' blob: data: gap:; connect-src self * 'unsafe-inline' blob: data: gap:; frame-src * self blob: data: gap:;" />
    <script>if (typeof module === 'object') {window.module = module; module = undefined;}
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>if (window.module) module = window.module;</script>
    <style>
        body {
            background-color: #6D6A75;
            font-family: Verdana, Geneva, Tahoma, sans-serif;
        }

        button:enabled {
            background-color: #DCD0FF;
            color: #3A3541;
            border: solid 1px #3A3541;
            border-radius: 12px;
            width: 230px;
            padding: 20px 32px;
            margin: 0 auto;
        }

        button:active {
            pointer-events: none;
        }

        button:hover {
            cursor: pointer;
        }

        button:hover:disabled {
            cursor: default;
        }

        button:disabled {
            background-color: #B2B0B9;
            color: #3A3541;
            border: solid 1px #3A3541;
            border-radius: 12px;
            width: 230px;
            padding: 20px 15px;
        }

        video {
            display: block;
            width: auto;
            height: 500px;
            margin-bottom: 25px;
            user-drag: none;
            user-select: none;
            /*position: fixed;*/
            /*top: 0;
            left: 0;*/          
        }

        .canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            background-color:rgba(255,0,0,0.5);
            }

        .size_of_buttons {
            font-size: 22px;
        }

        input[type="file"] {
            display: none;
        }

        div.absolute {
            position: absolute;
            top: 80px;
            left: 0;
            width: 200px;
            height: 100px;
            border: 2px solid #DCD0FF;
            background-color:rgba(155, 139, 139, 0.226);
        }

        div.anchor {
            width: 10px;
            height: 10px;
            background-color: crimson;
            position: absolute;
            border: 0;
            border-radius: 5px;
        }
    </style>
    <link href="./toastr-master/build/toastr.css" rel="stylesheet"/>
    <script src="./toastr-master/toastr.js"></script>
</head>

<body>
    
    <video  id="uploadedVideo" controls src="" controlsList="nofullscreen" >
    </video>

    <div id="subtitle_area" class="absolute" style="display: none;" >
        <div id="anchor-TL" class="anchor" style="left: -5px; top: -5px;"></div>
        <div id="anchor-BR" class="anchor" style="right: -5px; bottom: -5px;"></div>
    </div> 
    

    <label for="file-upload" style="display: inline-block;">
        <button type="button" id="UploadVideoButton" class="size_of_buttons">Upload Video</button>
    </label>
    <input id="file-upload" type="file" accept=".mp4" />

    <button type="button" id="SelectAreaButton" class="size_of_buttons" disabled>Select Area</button>
    <button type="button" id="ControlsButton" class="size_of_buttons" disabled>Hide Controls</button>
    <button type="button" id="DeleteSubtitlesButton" class="size_of_buttons" disabled>Delete Subtitles</button>


   <canvas id="canvasOverVideo" class="canvas" style="display: none;"></canvas>
   <script>
    const renderer = require('./renderer.js');
  </script>
    <script>    
        
        let widthOfSubtArea = 0;
        let heightOfSubtArea = 0;
        let leftUpClicked = 0;
        let widthOfVideo = 0;
        let heightOfVideo = 0;
        let leftUpX = 0;
        let leftUpY = 0;
        let RightDownX = 0;
        let RightDownY = 0;
        let videoElement = document.getElementById("uploadedVideo");
        let SelectAreaButton = document.getElementById("SelectAreaButton");
        let ControlsButton = document.getElementById("ControlsButton");
        let DeleteSubtitlesButton = document.getElementById("DeleteSubtitlesButton");
        let filePath;
        let directoryPath;
        let controls_showed = 0; //controls are not showwed
        
        

        $("#file-upload").change(onFileUpload);

        let WannaHide = function(e){ //is now showed
            console.log(controls_showed);
            console.log("YEAH SME TU A SKRYVMAE PANEL");
            $("video").attr("controls", false); //hide them
            document.getElementById("ControlsButton").textContent  = 'Show Controls';
            controls_showed = 0;
            console.log(controls_showed);

        }

        let WannaShow = function(e){ //is now hide
            console.log("Wanna show");
            $("video").attr("controls", true); //show them
            document.getElementById("ControlsButton").textContent  = 'Hide Controls';
            controls_showed = 1;
        }

        function onFileUpload(event) {
            filePath = $("#file-upload")[0].files[0].path;
            console.log(filePath);
            $("video").attr("src", filePath);
            document.getElementById("SelectAreaButton").disabled = false; //urobim tlacitko select area aktivne
            document.getElementById("ControlsButton").disabled = false; //urobim tlacitko hide controls aktivne
            WannaShow();
        }


        let handleClick = function(e) { 

            if (leftUpClicked == 0){
                leftUpX = (e.clientX + window.pageXOffset);
                leftUpY = (e.clientY + window.pageXOffset);
                leftUpClicked = 1;
                console.log("lava hore x" + leftUpX)
                console.log("lava hore y" + leftUpY)
                toastr.options = {
                    "closeButton": false,
                    "debug": false,
                    "newestOnTop": true,
                    "progressBar": false,
                    "positionClass": "toast-top-left",
                    "preventDuplicates": false,
                    "onclick": null,
                    "showDuration": "300",
                    "hideDuration": "1000",
                    "timeOut": "5000",
                    "extendedTimeOut": "500",
                    "showEasing": "swing",
                    "hideEasing": "linear",
                    "showMethod": "fadeIn",
                    "hideMethod": "fadeOut"
                    }
                toastr["info"]("Please select down right corner of subtitles area.", "Down Right Corner")
                //alert("Select down right corner of subtitle area");
            }
            else if (leftUpClicked == 1){
                RightDownX = (e.clientX + window.pageXOffset);
                RightDownY = (e.clientY + window.pageXOffset);
                //document.getElementById("subtitle_area").style.display = "inline" ;
                
                WannaShow();
                console.log("prava dole x" + RightDownX)
                console.log("prava dole y" + RightDownY)
                console.log("sirka videa" + widthOfVideo)
                console.log("vyska videa" + heightOfVideo)

                console.log("no toto by malo fungovat:::::::")
                heightOfVideo = $("video")[0].videoHeight; //vyska nahraneho videa
                widthOfVideo = $("video")[0].videoWidth; //sirka nahraneho videa
                console.log("vysoka origo", heightOfVideo)
                console.log("siroka origo", widthOfVideo);
                heightOfVideoInApp = $("video").height(); //vyska videa v konzole
                widthOfVideoInApp = $("video").width(); //sirka videa v konzole
                console.log("vysoka app", heightOfVideoInApp)
                console.log("siroka app", widthOfVideoInApp);

                
                widthOfSubtArea = Math.abs(RightDownX - leftUpX);
                heightOfSubtArea = Math.abs(leftUpY - RightDownY);

                console.log("sirka" + widthOfSubtArea)
                console.log("vyska" + heightOfSubtArea)
                //zobrazim ramcek kde su titulky

                $('div.absolute').css('top', leftUpY);
                $('div.absolute').css('left', leftUpX);
                $('div.absolute').css('width', widthOfSubtArea);
                $('div.absolute').css('height', heightOfSubtArea);
                $("#subtitle_area").show();

                //prepocitanie pomerovo ked je video male (nezvacsene)
                //-8 kvoli ramceku ktory je okolo video
                /*
                leftUpX = Math.round(-8 +(leftUpX/widthOfVideoInApp) * widthOfVideo)
                leftUpY = Math.round(-8 +(leftUpY/heightOfVideoInApp)*heightOfVideo)
                RightDownX = Math.round(-8 +(RightDownX/widthOfVideoInApp) * widthOfVideo)
                RightDownY = Math.round(-8 +(RightDownY/heightOfVideoInApp)*heightOfVideo)
                */
                

                console.log("CISLA PO NOVOM")
                console.log("prava dole x" + RightDownX)
                console.log("prava dole y" + RightDownY)
                console.log("lava hore x" + leftUpX)
                console.log("lava hore y" + leftUpY)

                leftUpClicked = 2;
                document.getElementById("DeleteSubtitlesButton").disabled = false; //urobim tlacitko delete subtitles aktivne

            }
  
            e.preventDefault();
        }

        let SelectAreaClicked = function(e){
            WannaHide();
            leftUpClicked = 0;
            videoElement.addEventListener("click", handleClick, false);
            videoElement.pause();
            toastr.options = {
                "closeButton": false,
                "debug": false,
                "newestOnTop": true,
                "progressBar": false,
                "positionClass": "toast-top-left",
                "preventDuplicates": false,
                "onclick": null,
                "showDuration": "300",
                "hideDuration": "1000",
                "timeOut": "5000",
                "extendedTimeOut": "500",
                "showEasing": "swing",
                "hideEasing": "linear",
                "showMethod": "fadeIn",
                "hideMethod": "fadeOut"
                }
            toastr["info"]("Please select upper left corner of subtitles area.", "Upper Left Corner")
            //alert("Select upper left corner of subtitle area");
        }

        let ControlsClicked = function(e){
            console.log("čo tu mame",controls_showed);
            if (controls_showed === 0){ //controls are not showwed
                console.log
                WannaShow();
            }
            else if (controls_showed === 1){//controls are  showwed
                WannaHide();
            }
        }

        let DeleteSubtitlesClicked = function(e){
            var area_to_be_deleted = document.getElementById("subtitle_area").getBoundingClientRect();
            console.log(area_to_be_deleted.top, area_to_be_deleted.right, area_to_be_deleted.bottom, area_to_be_deleted.left);

            leftUpX = area_to_be_deleted.left;
            leftUpY = area_to_be_deleted.top;
            RightDownX = area_to_be_deleted.right;
            RightDownY = area_to_be_deleted.bottom;

            leftUpX = Math.round(-8 +(leftUpX/widthOfVideoInApp) * widthOfVideo)
            leftUpY = Math.round(-8 +(leftUpY/heightOfVideoInApp)*heightOfVideo)
            RightDownX = Math.round(-8 +(RightDownX/widthOfVideoInApp) * widthOfVideo)
            RightDownY = Math.round(-8 +(RightDownY/heightOfVideoInApp)*heightOfVideo)



            renderer.skript(leftUpX, leftUpY, RightDownX ,RightDownY, filePath, heightOfVideo, widthOfVideo);
            toastr.options = {
                "closeButton": false,
                "debug": false,
                "newestOnTop": true,
                "progressBar": false,
                "positionClass": "toast-top-left",
                "preventDuplicates": false,
                "onclick": null,
                "showDuration": "300",
                "hideDuration": "1000",
                "timeOut": "10000",
                "extendedTimeOut": "5000",
                "showEasing": "swing",
                "hideEasing": "linear",
                "showMethod": "fadeIn",
                "hideMethod": "fadeOut"
                }
            toastr.success("Subtitles are being removed and the new video will be saved in the same directory as the uploaded video.", "Removing subtitles")
            
            //alert("Subtitles will be removed and the new video will be saved in the same directory as the uploaded video.")
        }

        SelectAreaButton.addEventListener("mousedown", SelectAreaClicked, false);
        DeleteSubtitlesButton.addEventListener("mousedown", DeleteSubtitlesClicked, false);
        ControlsButton.addEventListener("mousedown", ControlsClicked, false);

        // draggable dots around subtitle area
        let currentlyDraggedDot = null;

        function startDragTL(e) {
            currentlyDraggedDot = "TL";
        }

        function dragTL(e) {
            if (currentlyDraggedDot == "TL") {
                $("#subtitle_area").css("left", e.x);
                $("#subtitle_area").css("top", e.y);
            }
        }

        function stopDragBR(e) {
            currentlyDraggedDot = null;
        }

        function startDragBR(e) {
            currentlyDraggedDot = "BR";
            console.log("Start");
        }
        
        function dragBR(e) {
            console.log("Drag", currentlyDraggedDot);
            if (currentlyDraggedDot == "BR") {
                const sbLeft = parseInt($("#subtitle_area").css("left"), 10);
                const sbTop = parseInt($("#subtitle_area").css("top"), 10);
                
                $("#subtitle_area").css("width", e.x - sbLeft);
                $("#subtitle_area").css("height", e.y - sbTop);

                console.log("Som tu", sbLeft, sbTop, e.x, e.y)
            }
        }

        function stopDragTL(e) {
            currentlyDraggedDot = null;
        }

        document.getElementById("anchor-TL").addEventListener("mousedown", startDragTL);
        document.body.addEventListener("mousemove", dragTL);
        document.body.addEventListener("mouseup", stopDragTL);

        document.getElementById("anchor-BR").addEventListener("mousedown", startDragBR);
        document.body.addEventListener("mousemove", dragBR);
        document.body.addEventListener("mouseup", stopDragBR);
    </script>
</body>

</html>